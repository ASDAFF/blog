/* By Osvaldas Valutis, www.osvaldas.info. Available for use under the MIT License */
/* https://github.com/hovel/imagelightbox/tree/8f18b264f905f7cb1c2cfe495568e1e719df1acf */
(function(f,g,n,K){var l=function(){var a=n.body||n.documentElement,a=a.style;return""==a.WebkitTransition?"-webkit-":""==a.MozTransition?"-moz-":""==a.OTransition?"-o-":""==a.transition?"":!1},r=!1===l()?!1:!0,u=function(a,f,g){var c={},e=l();c[e+"transform"]="translateX("+f+")";c[e+"transition"]=e+"transform "+g+"s linear";a.css(c)},C="ontouchstart"in g,D=g.navigator.pointerEnabled||g.navigator.msPointerEnabled,x=function(a){if(C)return!0;if(!D||"undefined"===typeof a||"undefined"===typeof a.pointerType)return!1; if("undefined"!==typeof a.MSPOINTER_TYPE_MOUSE){if(a.MSPOINTER_TYPE_MOUSE!=a.pointerType)return!0}else if("mouse"!=a.pointerType)return!0;return!1};f.fn.imageLightbox=function(a){a=f.extend({dynamicalTargets:!1,allowedTypes:"png|jpg|jpeg|gif",groupByClosest:!1,zoomScale:[],animationSpeed:250,preloadNext:1,enableKeyboard:!0,quitOnEnd:!1,quitOnImgClick:!1,quitOnDocClick:!0,onStart:!1,onEnd:!1,onLoadStart:!1,onLoadEnd:!1},a);var y="",t={},c=f([]),e=f(),d=f(),m=0,k=0,p=0,q=!1,v=1,l=function(b){return"a"== f(b).prop("tagName").toLowerCase()&&(new RegExp(".("+a.allowedTypes+")$","i")).test(f(b).attr("href"))},E=function(b){b=f(b);return b.length&&a.groupByClosest?b.closest(a.groupByClosest).data("lightbox-group")||"default":"default"},z=function(){f(y).each(function(){if(!l(this))return!0;var b=f(this),a=E(b);t[a]=t[a]||f([]);t[a]=t[a].add(b)})},F=function(b){if(q)return!1;q=!1;a.dynamicalTargets&&z();b=f(b);c=f(t[E(b)]);if(!c.length)return console.log("no such targets"),!1;if(!1!==a.onStart)a.onStart(); e=b.length?b:c.first();A()},J=function(){for(var b=a.zoomScale.length-1;0<=b;b--)if(g.devicePixelRatio>=a.zoomScale[b])return a.zoomScale[b];return 1},G=function(a){a=a.attr("href");if(1==v)return a;var d="."+a.split(".").slice(-1)[0];return a.replace(d,"@"+v+"x"+d)},H=function(){if(!d.length)return!0;var a=.8*f(g).width(),c=.9*f(g).height(),h=new Image;h.src=d.attr("src");h.onload=function(){m=h.width/v;k=h.height/v;if(m>a||k>c){var e=m/k>a/c?m/a:k/c;m/=e;k/=e}d.css({width:m+"px",height:k+"px",top:(f(g).height()- k)/2+"px",left:(f(g).width()-m)/2+"px"});d.show()}},A=function(b){if(q)return!1;var g=1,h=!1;"undefined"!=typeof b&&("left"==b?(g=-1,h=1):h=-1);var k=c.index(e);if(d.length){if(!1!==h&&(2>c.length||!0===a.quitOnEnd&&(-1===h&&0==k||1===h&&k==c.length-1)))return w(),!1;b={opacity:0};r?u(d,100*h-p+"px",a.animationSpeed/1E3):b.left=parseInt(d.css("left"))+100*h+"px";d.animate(b,a.animationSpeed,function(){I()});p=0}q=!0;if(!1!==a.onLoadStart)a.onLoadStart();setTimeout(function(){v=J();d=f('<img id="imagelightbox" />').attr("src", G(e)).load(function(){d.hide().appendTo("body");H();var b={opacity:1};d.css("opacity",0);if(r)u(d,-100*h+"px",0),setTimeout(function(){u(d,"0px",a.animationSpeed/1E3)},50);else{var e=parseInt(d.css("left"));b.left=e+"px";d.css("left",e-100*h+"px")}d.animate(b,a.animationSpeed,function(){q=!1;if(!1!==a.onLoadEnd)a.onLoadEnd()});if(0<a.preloadNext)for(b=1;b<=a.preloadNext;b++)e=k+b*g,e>c.length-1?e-=c.length:0>e&&(e+=c.length),e=c.eq(e),f("<img />").attr("src",G(e)).load()}).error(function(){if(!1!== a.onLoadEnd)a.onLoadEnd()});var b=0,n=0,l=0;d.on(D?"pointerup MSPointerUp":"click",function(b){b.preventDefault();if(a.quitOnImgClick)return w(),!1;if(x(b.originalEvent))return!0;B(m/2>(b.pageX||b.originalEvent.pageX)-b.target.offsetLeft?"left":"right")}).on("touchstart pointerdown MSPointerDown",function(c){if(!x(c.originalEvent)||a.quitOnImgClick)return!0;r&&(l=parseInt(d.css("left")));b=c.originalEvent.pageX||c.originalEvent.touches[0].pageX}).on("touchmove pointermove MSPointerMove",function(c){if(!x(c.originalEvent)|| a.quitOnImgClick)return!0;c.preventDefault();n=c.originalEvent.pageX||c.originalEvent.touches[0].pageX;p=b-n;r?u(d,-p+"px",0):d.css("left",l-p+"px")}).on("touchend touchcancel pointerup pointercancel MSPointerUp MSPointerCancel",function(b){if(!x(b.originalEvent)||a.quitOnImgClick)return!0;50<Math.abs(p)?B(0<p?"right":"left"):r?u(d,"0px",a.animationSpeed/1E3):d.animate({left:l+"px"},a.animationSpeed/2)})},a.animationSpeed+100)},B=function(a){if(q)return!1;if(-1>a||a>c.length)return console.log("index is out of range"), !1;var d=a,f=c.index(e);"left"==a?d=f-1:"right"==a&&(d=f+1);e=-1==d?c.eq(c.length-1):d==c.length?c.eq(0):c.eq(d);A(d<f?"left":"right")},I=function(){if(!d.length)return!1;d.remove();d=f()},w=function(){if(!d.length)return!1;d.animate({opacity:0},a.animationSpeed,function(){I();q=!1;if(!1!==a.onEnd)a.onEnd()})};f(g).on("resize",H);if(a.quitOnDocClick)f(n).on(C?"touchend":"click",function(a){d.length&&!f(a.target).is(d)&&w()});if(a.enableKeyboard)f(n).on("keyup",function(a){if(!d.length)return!0;a.preventDefault(); 27==a.keyCode&&w();if(37==a.keyCode||39==a.keyCode)e=c.eq(c.index(e)-(37==a.keyCode?1:-1)),e.length||(e=c.eq(37==a.keyCode?c.length:0)),A(37==a.keyCode?"left":"right")});y=this.selector;f(n).on("click",y,function(a){if(!l(this))return!0;a.preventDefault();F(this)});z();this.start=F;this.collectTargets=z;this.switchImageLightbox=B;this.getTarget=function(){return e};this.targetIsSingle=function(){return 2>c.length};this.targetIsFirst=function(){return a.quitOnEnd&&0==c.index(e)};this.targetIsLast= function(){return a.quitOnEnd&&c.index(e)==c.length-1};this.quitImageLightbox=function(){w();return this};return this}})(jQuery,window,document);
